<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Log Viewer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; background: #0d1117; color: #c9d1d9; padding: 16px; }
  h1 { font-size: 18px; margin-bottom: 12px; color: #58a6ff; }
  .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; align-items: end; }
  .filters label { display: flex; flex-direction: column; gap: 2px; font-size: 12px; color: #8b949e; }
  .filters input, .filters select { background: #161b22; border: 1px solid #30363d; color: #c9d1d9; padding: 6px 8px; border-radius: 4px; font-size: 14px; font-family: inherit; }
  .filters input:focus, .filters select:focus { outline: none; border-color: #58a6ff; }
  button { background: #238636; color: #fff; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; height: 32px; }
  button:hover { background: #2ea043; }
  .stats { font-size: 12px; color: #8b949e; margin-bottom: 8px; }
  .log-list { display: flex; flex-direction: column; gap: 4px; }
  .log-entry { background: #161b22; border: 1px solid #30363d; border-radius: 4px; padding: 8px 12px; font-size: 13px; line-height: 1.5; }
  .log-entry:hover { border-color: #484f58; }
  .log-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px; align-items: center; }
  .log-time { color: #8b949e; }
  .log-tag { color: #d2a8ff; }
  .log-sid { color: #8b949e; font-size: 11px; }
  .log-msg { color: #c9d1d9; word-break: break-word; }
  .log-ctx { color: #8b949e; font-size: 12px; margin-top: 4px; word-break: break-word; }
  .level-error { color: #f85149; font-weight: bold; }
  .level-warn { color: #d29922; font-weight: bold; }
  .level-info { color: #58a6ff; }
  .level-debug { color: #8b949e; }
  .empty { color: #484f58; text-align: center; padding: 40px; }
</style>
</head>
<body>

<h1>Debug Log Viewer</h1>

<div class="filters">
  <label>Date <input type="date" id="date"></label>
  <label>Level
    <select id="level">
      <option value="">All</option>
      <option value="error">error</option>
      <option value="warn">warn</option>
      <option value="info">info</option>
      <option value="debug">debug</option>
    </select>
  </label>
  <label>Tag <input type="text" id="tag" placeholder="e.g. snapshot"></label>
  <label>Session <input type="text" id="sid" placeholder="sid"></label>
  <label>Search <input type="text" id="q" placeholder="keyword"></label>
  <button onclick="fetchLogs()">Query</button>
</div>

<div class="stats" id="stats"></div>
<div class="log-list" id="logs"></div>

<script>
// Default date to today in UTC+8
const now = new Date(Date.now() + 8 * 60 * 60 * 1000);
document.getElementById('date').value = now.toISOString().slice(0, 10);

async function fetchLogs() {
  const params = new URLSearchParams();
  const date = document.getElementById('date').value;
  const level = document.getElementById('level').value;
  const tag = document.getElementById('tag').value.trim();
  const sid = document.getElementById('sid').value.trim();
  const q = document.getElementById('q').value.trim();

  if (date) params.set('date', date);
  if (level) params.set('level', level);
  if (tag) params.set('tag', tag);
  if (sid) params.set('sid', sid);
  if (q) params.set('q', q);

  const res = await fetch('/logs?' + params);
  const logs = await res.json();

  document.getElementById('stats').textContent = `${logs.length} entries`;

  const container = document.getElementById('logs');
  if (logs.length === 0) {
    container.innerHTML = '<div class="empty">No logs found</div>';
    return;
  }

  container.innerHTML = logs.map(log => {
    const time = log.receivedAt?.replace('+08:00', '').replace('T', ' ') || '';
    const ctx = log.ctx ? JSON.stringify(log.ctx) : '';
    return `<div class="log-entry">
      <div class="log-meta">
        <span class="log-time">${esc(time)}</span>
        <span class="level-${log.level}">${esc(log.level)}</span>
        <span class="log-tag">${esc(log.tag)}</span>
        <span class="log-sid">${esc(log.sid || '')}</span>
      </div>
      <div class="log-msg">${esc(log.msg)}</div>
      ${ctx ? `<div class="log-ctx">${esc(ctx)}</div>` : ''}
    </div>`;
  }).join('');
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

fetchLogs();
</script>
</body>
</html>
